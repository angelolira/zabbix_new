#!/bin/bash
set -e

clear

# ========================
# Vari√°veis
# ========================
ARQUIVO_CONF_URL="https://raw.githubusercontent.com/angelolira/zabbix_new/refs/heads/main/Linux/zabbix/zabbix_agentd.conf"
ARQUIVO_CONF="zabbix_agentd.conf"
ZABBIX_DIR="/etc/zabbix"

# ========================
# Fun√ß√µes utilit√°rias
# ========================
require_root() {
    if [[ "$(id -u)" != "0" ]]; then
        echo "‚ùå Execute este script como root."
        exit 1
    fi
}

detect_os() {
    if [[ -f /etc/os-release ]]; then
        source /etc/os-release
        OS_ID="$ID"
        OS_VERSION="$VERSION_ID"
    elif [[ -f /etc/redhat-release ]]; then
        OS_ID="rhel"
        OS_VERSION=$(sed 's/.*release \([0-9]\).*/\1/' /etc/redhat-release)
    else
        echo "‚ùå N√£o foi poss√≠vel detectar o sistema operacional."
        exit 1
    fi
}

pkg_install() {
    case "$OS_VERSION" in
        6*|7*) yum install -y "$@";;
        8*|9*) dnf install -y "$@";;
    esac
}

service_enable() {
    case "$OS_VERSION" in
        6*) chkconfig "$1" on;;
        *)  systemctl enable "$1";;
    esac
}

service_restart() {
    case "$OS_VERSION" in
        6*) service "$1" restart;;
        *)  systemctl restart "$1";;
    esac
}

# ========================
# Zabbix
# ========================
install_zabbix_common() {
    mkdir -p "$ZABBIX_DIR"
    cd /root
    curl -fsSLO "$ARQUIVO_CONF_URL"
    cp -f "$ARQUIVO_CONF" "$ZABBIX_DIR/"
}

install_agent1() {
    echo "‚û° Instalando Zabbix Agent (cl√°ssico)"
    case "$OS_VERSION" in
        6*)
            rpm -Uvh https://repo.zabbix.com/zabbix/6.0/rhel/6/x86_64/zabbix-release-6.0-4.el6.noarch.rpm
            pkg_install zabbix-agent
            service_enable zabbix-agent
            service_restart zabbix-agent
            ;;
        7*)
            rpm -Uvh https://repo.zabbix.com/zabbix/6.0/rhel/7/x86_64/zabbix-release-6.0-4.el7.noarch.rpm
            pkg_install zabbix-agent
            service_enable zabbix-agent
            service_restart zabbix-agent
            ;;
        8*)
            rpm -Uvh https://repo.zabbix.com/zabbix/6.0/rhel/8/x86_64/zabbix-release-6.0-4.el8.noarch.rpm
            pkg_install zabbix-agent
            service_enable zabbix-agent
            service_restart zabbix-agent
            ;;
        9*)
            rpm -Uvh https://repo.zabbix.com/zabbix/6.0/rhel/9/x86_64/zabbix-release-6.0-4.el9.noarch.rpm
            pkg_install zabbix-agent
            service_enable zabbix-agent
            service_restart zabbix-agent
            ;;
    esac
}

install_agent2() {
    echo "‚û° Instalando Zabbix Agent 2"
    case "$OS_VERSION" in
        6*)
            echo "‚ùå Zabbix Agent 2 n√£o √© suportado no RHEL 6"
            exit 1
            ;;
        7*)
            rpm -Uvh https://repo.zabbix.com/zabbix/6.0/rhel/7/x86_64/zabbix-release-6.0-4.el7.noarch.rpm
            pkg_install zabbix-agent2
            service_enable zabbix-agent2
            service_restart zabbix-agent2
            ;;
        8*)
            rpm -Uvh https://repo.zabbix.com/zabbix/6.0/rhel/8/x86_64/zabbix-release-6.0-4.el8.noarch.rpm
            pkg_install zabbix-agent2
            service_enable zabbix-agent2
            service_restart zabbix-agent2
            ;;
        9*)
            rpm -Uvh https://repo.zabbix.com/zabbix/6.0/rhel/9/x86_64/zabbix-release-6.0-4.el9.noarch.rpm
            pkg_install zabbix-agent2
            service_enable zabbix-agent2
            service_restart zabbix-agent2
            ;;
    esac
}

zabbix_install_menu() {
    echo
    echo "Qual vers√£o deseja instalar?"
    echo "1 - Zabbix Agent (cl√°ssico)"
    echo "2 - Zabbix Agent 2"
    echo
    read -rp "Escolha: " agent_opt

    case "$agent_opt" in
        1) install_agent1;;
        2) install_agent2;;
        *) echo "Op√ß√£o inv√°lida"; sleep 2; zabbix_install_menu;;
    esac

    install_zabbix_common
    echo "‚úÖ Zabbix instalado com sucesso!"
}

zabbix_remove() {
    detect_os
    echo "üóë Removendo Zabbix..."

    case "$OS_VERSION" in
        6*|7*) yum remove -y zabbix-agent zabbix-agent2 zabbix-release;;
        8*|9*) dnf remove -y zabbix-agent zabbix-agent2 zabbix-release;;
    esac

    rm -rf "$ZABBIX_DIR"
    echo "‚úÖ Zabbix removido."
}

# ========================
# Menu
# ========================
main_menu() {
    require_root
    detect_os

    clear
    echo "==============================="
    echo "   INSTALADOR ZABBIX"
    echo "==============================="
    echo "Sistema detectado: $OS_ID $OS_VERSION"
    echo
    echo "1 - Instalar Zabbix"
    echo "2 - Remover Zabbix"
    echo "0 - Sair"
    echo
    read -rp "Escolha uma op√ß√£o: " opt

    case "$opt" in
        1) zabbix_install_menu;;
        2) zabbix_remove;;
        0) exit 0;;
        *) echo "Op√ß√£o inv√°lida"; sleep 2; main_menu;;
    esac
}

main_menu
