#!/bin/bash
set -e
clear

# ========================
# VariÃ¡veis
# ========================
CONF_AGENT1_URL="https://raw.githubusercontent.com/angelolira/zabbix_new/refs/heads/main/Linux/zabbix/zabbix_agentd.conf"
CONF_AGENT2_URL="https://raw.githubusercontent.com/angelolira/zabbix_new/refs/heads/main/Linux/zabbix/zabbix_agent2.conf"

CONF_AGENT1_MARINGA_URL="https://raw.githubusercontent.com/angelolira/zabbix_new/refs/heads/main/Linux/zabbix/zabbix_agentMGA.conf"
CONF_AGENT2_MARINGA_URL="https://raw.githubusercontent.com/angelolira/zabbix_new/refs/heads/main/Linux/zabbix/zabbix_agent2MGA.conf"

CONF_AGENT1="zabbix_agentd.conf"
CONF_AGENT2="zabbix_agent2.conf"

ZABBIX_DIR="/etc/zabbix"
SUDOERS_FILE="/etc/sudoers.d/zabbix"

SUDOERS_LINE='zabbix ALL=(root) NOPASSWD: \
/bin/systemctl restart nginx, \
/bin/systemctl restart tomcat, \
/bin/systemctl restart httpd'

# ========================
# FunÃ§Ãµes utilitÃ¡rias
# ========================
require_root() {
    [[ "$(id -u)" == "0" ]] || { echo "âŒ Execute este script como root."; exit 1; }
}

detect_os() {
    source /etc/os-release
    OS_ID="$ID"
    OS_VERSION="$VERSION_ID"
}

pkg_install() {
    case "$OS_VERSION" in
        6*|7*) yum install -y "$@";;
        8*|9*) dnf install -y "$@";;
    esac
}

pkg_remove() {
    case "$OS_VERSION" in
        6*|7*) yum remove -y "$@";;
        8*|9*) dnf remove -y "$@";;
    esac
}

service_enable() {
    [[ "$OS_VERSION" == 6* ]] && chkconfig "$1" on || systemctl enable "$1"
}

service_restart() {
    [[ "$OS_VERSION" == 6* ]] && service "$1" restart || systemctl restart "$1"
}

add_zabbix_sudoers() {
    if ! id zabbix &>/dev/null; then
        echo "ðŸ‘¤ Criando usuÃ¡rio zabbix..."
        useradd -r -s /sbin/nologin zabbix
    fi

    echo "âœ Criando regra sudoers..."
    echo "$SUDOERS_LINE" > "$SUDOERS_FILE"
    chmod 440 "$SUDOERS_FILE"
    visudo -cf "$SUDOERS_FILE"
    echo "âœ” Sudoers do zabbix validado"
}

add_userparameters() {
    local UP_FILE="$ZABBIX_DIR/zabbix_agentd.d/custom_linux.conf"
    echo "âž• Criando UserParameters..."

    cat > "$UP_FILE" <<EOF
UserParameter=custom.df,df -h
UserParameter=custom.free,free -m
UserParameter=custom.top,top -b -n1 | head -20
EOF
}

# ========================
# InstalaÃ§Ã£o
# ========================
install_agent1() {
    echo "âž¡ Instalando Zabbix Agent (clÃ¡ssico)"

    case "$OS_VERSION" in
        6*) rpm -Uvh https://repo.zabbix.com/zabbix/6.0/rhel/6/x86_64/zabbix-release-6.0-4.el6.noarch.rpm;;
        7*) rpm -Uvh https://repo.zabbix.com/zabbix/6.0/rhel/7/x86_64/zabbix-release-6.0-4.el7.noarch.rpm;;
        8*) rpm -Uvh https://repo.zabbix.com/zabbix/6.0/rhel/8/x86_64/zabbix-release-6.0-4.el8.noarch.rpm;;
        9*) rpm -Uvh https://repo.zabbix.com/zabbix/6.0/rhel/9/x86_64/zabbix-release-6.0-4.el9.noarch.rpm;;
    esac

    pkg_install zabbix-agent
    service_enable zabbix-agent

    if [[ "$SITE" == "MARINGA" ]]; then
        curl -fsSLo "$ZABBIX_DIR/$CONF_AGENT1" "$CONF_AGENT1_MARINGA_URL"
    else
        echo "â„¹ TimbÃ³: mantendo conf original"
    fi

    add_userparameters
    add_zabbix_sudoers
    service_restart zabbix-agent
}

install_agent2() {
    echo "âž¡ Instalando Zabbix Agent 2"

    case "$OS_VERSION" in
        6*) echo "âŒ Agent2 nÃ£o suporta RHEL 6"; exit 1;;
        7*) rpm -Uvh https://repo.zabbix.com/zabbix/6.0/rhel/7/x86_64/zabbix-release-6.0-4.el7.noarch.rpm;;
        8*) rpm -Uvh https://repo.zabbix.com/zabbix/6.0/rhel/8/x86_64/zabbix-release-6.0-4.el8.noarch.rpm;;
        9*) rpm -Uvh https://repo.zabbix.com/zabbix/6.0/rhel/9/x86_64/zabbix-release-6.0-4.el9.noarch.rpm;;
    esac

    pkg_install zabbix-agent2
    service_enable zabbix-agent2

    if [[ "$SITE" == "MARINGA" ]]; then
        curl -fsSLo "$ZABBIX_DIR/$CONF_AGENT2" "$CONF_AGENT2_MARINGA_URL"
    else
        echo "â„¹ TimbÃ³: mantendo conf original"
    fi

    add_userparameters
    add_zabbix_sudoers
    service_restart zabbix-agent2
}

# ========================
# RemoÃ§Ã£o
# ========================
zabbix_remove() {
    echo "ðŸ—‘ Removendo Zabbix..."
    pkg_remove zabbix-agent zabbix-agent2 zabbix-release || true
    rm -rf "$ZABBIX_DIR" "$SUDOERS_FILE"
    echo "âœ… Zabbix removido."
}

# ========================
# Menus
# ========================
choose_site() {
    echo
    echo "Selecione a localidade:"
    echo "1 - MARINGÃ"
    echo "2 - TIMBÃ“"
    read -rp "Escolha: " site_opt

    case "$site_opt" in
        1) SITE="MARINGA";;
        2) SITE="TIMBO";;
        *) echo "OpÃ§Ã£o invÃ¡lida"; sleep 2; choose_site;;
    esac
}

zabbix_install_menu() {
    echo
    echo "Qual versÃ£o deseja instalar?"
    echo "1 - Zabbix Agent (clÃ¡ssico)"
    echo "2 - Zabbix Agent 2"
    read -rp "Escolha: " agent_opt

    choose_site

    case "$agent_opt" in
        1) install_agent1;;
        2) install_agent2;;
        *) echo "OpÃ§Ã£o invÃ¡lida"; sleep 2; zabbix_install_menu;;
    esac

    echo "ðŸŽ‰ Zabbix instalado para o site: $SITE"
}

main_menu() {
    require_root
    detect_os

    clear
    echo "==============================="
    echo "   INSTALADOR ZABBIX"
    echo "==============================="
    echo "Sistema: $OS_ID $OS_VERSION"
    echo
    echo "1 - Instalar Zabbix"
    echo "2 - Remover Zabbix"
    echo "0 - Sair"
    read -rp "Escolha: " opt

    case "$opt" in
        1) zabbix_install_menu;;
        2) zabbix_remove;;
        0) exit 0;;
        *) echo "OpÃ§Ã£o invÃ¡lida"; sleep 2; main_menu;;
    esac
}

main_menu
